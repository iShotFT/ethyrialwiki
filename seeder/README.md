# EthyrialWiki Unified Seeder

This directory contains the consolidated scripts and utilities for seeding all game-related data into the EthyrialWiki database and associated S3 buckets.

## Structure

- `scripts/`: Contains the main runner script (`run.ts`).
- `lib/`: Contains modular TypeScript functions for different seeding tasks (core data, items/icons, maps, resources, tiles, S3 utils, general utils).
- `python_scripts/`: Contains Python scripts for processing `.minimap` files (`extract_minimap.py`, `stitch_minimap.py`).
- `input/`: **(Gitignored - Add manually)** Place necessary input files here:
  - `background.png`: The base map background image (6000x5000).
  - `markers_markers_full_dump.json`: JSON dump containing map marker data.
  - `scraped_objects.json`: JSON dump containing resource node data.
  - `resource_icon_map.json`: JSON mapping resource names to icon filenames and categories.
  - `icons/`: A directory containing all `*_Icon.png` files.
  - `minimap_data/`: A directory containing all `.minimap` files.
- `output/`: **(Gitignored)** Intermediate and final files generated by the scripts (extracted tiles, stitched maps).

## Prerequisites

1.  **Node.js & Yarn:** Ensure Node.js (v18-v20 recommended) and Yarn are installed.
2.  **Python:** Ensure Python 3 is installed and available as `python3` on your PATH.
3.  **Python Libraries:** Install required libraries: `pip install Pillow`
4.  **Environment Variables:** Ensure all necessary environment variables are configured (database connection, AWS credentials, S3 bucket names, etc.) via your `.env` file or system environment.
5.  **Input Files:** Place all required source files into the `seeder/input/` directory as described above.

## Usage

Run the unified seeder using the following yarn command:

```bash
yarn seed:all [options]
```

### Options

- `--skip-python`: Skips the Python scripts for extracting and stitching minimap tiles. Useful if you already have the extracted tiles in `output/extracted_tiles/`.
- `--skip-tile-upload`: Skips uploading the extracted map tiles (from `output/extracted_tiles/`) to S3.
- `--skip-icon-upload`: Skips uploading item/category icons (from `input/icons/`) to S3. The script will assume the icons already exist at the expected S3 paths.
- `--map-title <title>`: Specifies the map title to use when seeding resources (`seedResources`) and uploading map tiles (`seedMapTiles`). Defaults to "Irumesa".

Example: Run everything except Python scripts and icon uploads:

```bash
yarn seed:all --skip-python --skip-icon-upload
```

## Seeded Data

The seeder populates or updates the following database tables:

- `game_skills`
- `game_item_rarities`
- `game_icons`
- `game_item_categories` (including Ore/Bar categories and resource-derived categories)
- `game_items` (including Ores, Bars, and resource-derived items)
- `game_maps`
- `map_icons`
- `marker_categories`
- `markers` (from JSON dump)
- `game_resources` (from JSON dump)
- `game_item_item_category` (join table)

It also uploads files to the configured S3 bucket:

- Map tiles (e.g., `maps/irumesa/tiles/1/0-0-1.png`)
- Item/Category icons (e.g., `icons/Copper_Ore_Icon.png`)

## Idempotency

The seeder is designed to be idempotent. Running it multiple times will:

- **Create** records if they don't exist (based on deterministic UUIDs generated from slugs/names).
- **Update** existing records with the latest data from the source files/definitions.
- **Not** create duplicate records.
