# EthyrialWiki Unified Seeder

This directory contains the consolidated scripts and utilities for seeding all game-related data into the EthyrialWiki database and associated S3 buckets.

## Structure

- `scripts/`: Contains the main runner script (`run.ts`).
- `lib/`: Contains modular TypeScript functions for different seeding tasks (core data, items/icons, maps, resources, tiles, S3 utils, general utils).
- `python_scripts/`: Contains Python scripts for processing `.minimap` files (`extract_minimap.py`, `stitch_minimap.py`) related to map tile generation.
- `csharp_scripts/`: **(Generated)** Destination directory for the compiled C# marker extraction tool (`markers.exe`).
- `tools/csharp/markers/`: Contains the source code for the C# marker extraction tool.
- `logs/`: **(Generated)** Contains structured log files with seeder execution details and statistics.
- `input/`: **(Gitignored - Add manually)** Place necessary input files here:
  - `background.png`: The base map background image (6000x5000).
  - `markers_markers_full_dump.json`: **(Generated)** JSON dump containing map marker data, generated by the C# marker extraction tool from `input/minimap_data/markers.minimapdata`.
  - `scraped_objects.json`: JSON dump containing resource node data.
  - `resource_icon_map.json`: JSON mapping resource names to icon filenames and categories.
  - `icons/`: A directory containing all `*_Icon.png` files.
  - `minimap_data/`: A directory containing `.minimap` files (map tile source) and `markers.minimapdata` (marker source).
- `output/`: **(Gitignored)** Intermediate and final files generated by the scripts (extracted tiles, stitched maps).

## Prerequisites

1.  **Node.js & Yarn:** Ensure Node.js (v18-v20 recommended) and Yarn are installed.
2.  **.NET SDK:** Ensure the .NET SDK (v8.0 or compatible) is installed and the `dotnet` command is available on your PATH. This is required to build the C# marker extraction tool.
3.  **Python:** Ensure Python 3 is installed and available as `python` on your PATH. Required for the optional map tile extraction/stitching scripts (`extract_minimap.py`, `stitch_minimap.py`).
4.  **Python Libraries:** Install required libraries for map tile scripts: `pip install Pillow`
5.  **Environment Variables:** Ensure all necessary environment variables are configured (database connection, AWS credentials, S3 bucket names, etc.) via your `.env` file or system environment.
6.  **Input Files:** Place all required source files into the `seeder/input/` directory as described above, *except* for `markers_markers_full_dump.json` which is generated automatically. You MUST provide `seeder/input/minimap_data/markers.minimapdata`.

## Usage

Run the unified seeder using the following yarn command:

```bash
yarn seed:all [options]
```

### Workflow Steps

When `yarn seed:all` is executed, it performs the following steps:

1.  **Redis Cache Flush:** Flushes all keys from Redis cache by default to ensure a clean state (can be skipped with `--skip-redis-flush`).
2.  **(Optional) Python Map Processing:** If `--skip-python` is not provided, runs `extract_minimap.py` to generate map tiles in `output/extracted_tiles/`.
3.  **C# Marker Extraction:**
    - Builds the C# project located in `tools/csharp/markers/` using `dotnet build`.
    - Copies the resulting `markers.exe` to `seeder/csharp_scripts/`.
    - Executes `markers.exe` using `seeder/input/minimap_data/markers.minimapdata` as input with the `--non-interactive` flag to allow automated execution.
    - Moves the generated `markers_markers_full_dump.json` from `seeder/input/minimap_data/` to `seeder/input/`.
4.  **Database Seeding:** Runs the core data, map data (using the generated JSON), item/icon, resource seeding, and custom domain seeding functions within a database transaction.
5.  **(Optional) Map Tile Upload:** If `--skip-tile-upload` is not provided, uploads the generated map tiles from `output/extracted_tiles/` to S3.

### Options

- `--skip-python`: Skips the Python scripts for extracting and stitching minimap tiles. Useful if you already have the extracted tiles in `output/extracted_tiles/`.
- `--skip-tile-upload`: Skips uploading the extracted map tiles (from `output/extracted_tiles/`) to S3.
- `--upload-icons`: Enables uploading item/category icons (from `input/icons/`) to S3. By default, icon uploads are disabled.
- `--skip-resources`: Skips resource seeding. Useful for quicker testing or when you only need to update domains or other data.
- `--skip-custom-domains`: Skips custom domain seeding. Use this if you don't want to modify existing domain configurations.
- `--skip-redis-flush`: Skips flushing the Redis cache. Use this if you want to preserve cached data.
- `--map-title <title>`: Specifies the map title to use when seeding resources (`seedResources`) and uploading map tiles (`seedMapTiles`). Defaults to "Irumesa".
- `--batch-size <size>`: Sets the database operation batch size for large operations. Smaller values use less memory but may be slower. Defaults to 100.

### Convenience Scripts

```bash
# Run everything
yarn seed:all

# Only seed custom domains (skips Python, resources, and tile upload)
yarn seed:domains

# Only flush Redis cache (skips all data seeding)
yarn flush:redis

# Run everything except Python scripts and enable icon uploads
yarn seed:all --skip-python --upload-icons
```

## Logging System

The seeder includes a comprehensive logging system that generates detailed logs of each seeding operation:

- **Log Location**: All logs are saved in the `seeder/logs` directory with timestamped filenames.
- **Log Format**: Logs include timestamps, step durations, record counts, and error information.
- **Summary Information**: Each log concludes with a summary showing total runtime and records processed.

This logging system provides:
- A concise overview of the seeding process
- Timing information for performance monitoring
- Record counts for validation
- Structured format for easy reading and parsing

Example log output:
```
[INFO] 2023-07-15T12:34:56.789Z - Seeder started at 2023-07-15T12:34:56.789Z
[INFO] 2023-07-15T12:34:56.790Z - Log file: /path/to/seeder/logs/seeder-2023-07-15T12-34-56.log
[INFO] 2023-07-15T12:34:56.791Z - Starting step: Redis Cache Flush
[INFO] 2023-07-15T12:34:57.123Z - Completed step: Redis Cache Flush in 0.33s
[INFO] 2023-07-15T12:34:57.124Z - Starting step: C# Marker Extraction
[INFO] 2023-07-15T12:35:02.456Z - Completed step: C# Marker Extraction in 5.33s
[INFO] 2023-07-15T12:35:02.457Z - Starting step: Core Database Seeding
[INFO] 2023-07-15T12:35:03.789Z - Map Icons: 12 created, 4 updated
[INFO] 2023-07-15T12:35:05.012Z - Marker Categories: 18 created, 0 updated
[INFO] 2023-07-15T12:35:07.345Z - Completed step: Core Database Seeding in 4.89s
...

====================
SEEDER SUMMARY
====================
Total runtime: 45.67s

Records processed:
- Map Icons: 16
- Marker Categories: 18
- Markers: 256
- Custom Domains: 2

Seeder completed at 2023-07-15T12:35:42.459Z
====================
```

## Recent Improvements

### Structured Logging System
A dedicated logging system has been added that:
- Creates timestamped log files in `seeder/logs` directory
- Records detailed information about each seeding step
- Tracks timing information and record counts
- Produces a comprehensive summary at the end of the process
- Maintains both console and file logging

### Redis Cache Flushing
A Redis cache flushing step has been added to ensure a clean state when seeding data. This step:
- Executes a `FLUSHALL` command that clears all keys in Redis
- Removes cached map tiles, heatmap data, and custom domain configurations
- Can be skipped with the `--skip-redis-flush` flag if needed
- Is available as a standalone command with `yarn flush:redis`

### Custom Domain Seeding
A new seeder for custom domains has been added that creates subdomains for map and app access. The seeder intelligently determines the base domain from environment variables:
- Uses `PUBLIC_URL` or `URL` to derive the base domain
- Automatically creates `map.{basedomain}` and `app.{basedomain}` entries with appropriate handler types
- The `map.{basedomain}` domain is configured with the Irumesa map ID for immediate map display
- For local development, falls back to `localhost` if needed

### Batched Resource Processing
The resource seeding process has been enhanced to handle large datasets efficiently:
- Processes resources in configurable batches to manage memory usage
- Uses separate transactions per batch for better error containment
- Shows progress information during the lengthy resource seeding process
- Optimizes database operations by batching inserts and updates

### C# Marker Extractor Non-Interactive Mode
The C# marker extraction tool now supports a `--non-interactive` flag that allows it to run in automated environments without requiring user input. This eliminates the need for manual interaction during the seeding process.

### Enhanced Minimap Tile Processing
The `extract_minimap.py` script has been updated to properly handle negative Z coordinates in minimap filenames. It now supports filename formats with negative coordinates.

## Seeded Data

The seeder populates or updates the following database tables:

- `game_skills` - Combat, discipline, and profession skills
- `game_item_rarities` - Item rarity definitions (Common, Rare, Epic, etc.)
- `game_icons` - Icons for items, categories, and map markers
- `game_item_categories` - Item categories with display groups for heatmap
- `game_items` - Game items including ores, bars, and resource-derived items
- `game_maps` - Map definitions for Irumesa and Isle of Solitude
- `map_icons` - Icons used for map markers
- `marker_categories` - Categories for map markers with parent-child relationships
- `markers` - Map markers generated from the C# tool output
- `game_resources` - Resource nodes with coordinates on the map
- `game_item_item_category` - Join table for item-category relationships
- `custom_domains` - Subdomain routing configuration for map and app interfaces

It also uploads files to the configured S3 bucket:

- Map tiles (e.g., `maps/irumesa/tiles/1/0-0-1.png`)
- Item/Category icons (e.g., `icons/Copper_Ore_Icon.png`)

## Environment Variables

The seeder requires the following environment variables:

- **Database**:
  - Database connection settings (used through the server configuration)

- **AWS/S3**:
  - `AWS_REGION`: The AWS region for S3 operations
  - `AWS_S3_UPLOAD_BUCKET_NAME`: Bucket name for uploads
  - `AWS_S3_UPLOAD_BUCKET_URL`: S3 endpoint URL
  - `AWS_S3_FORCE_PATH_STYLE`: Whether to use path-style S3 URLs
  - `AWS_ACCESS_KEY_ID`: AWS access key ID
  - `AWS_SECRET_ACCESS_KEY`: AWS secret access key
  - `AWS_S3_ACL`: ACL setting for uploaded files (e.g., "public-read")

- **Application URLs**:
  - `PUBLIC_URL`: Public-facing URL used to derive custom domain names
  - `URL`: Alternative URL used if PUBLIC_URL is not available

## Idempotency

The seeder is designed to be idempotent. Running it multiple times will:

- **Create** records if they don't exist (based on deterministic UUIDs generated from slugs/names).
- **Update** existing records with the latest data from the source files/definitions.
- **Not** create duplicate records.
